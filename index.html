<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soda Planner v5.2</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜•</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .deleting { background-color: #fee2e2 !important; border-color: #ef4444 !important; transition: background 0.2s; }
        .toggle-checkbox:checked { right: 0; border-color: #2563EB; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans pb-24 select-none">

    <div class="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative overflow-hidden flex flex-col">
        
        <header class="bg-blue-600 p-4 text-white shadow-md sticky top-0 z-20 flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="ph ph-coffee text-2xl" aria-hidden="true"></i> Soda Planner
            </h1>
            <div class="flex gap-2">
                <button onclick="duplicarSemanaSiguiente()" class="text-xs bg-blue-700 p-2 rounded hover:bg-blue-500 transition flex items-center gap-1" title="Copiar esta semana a la siguiente">
                    <i class="ph ph-copy"></i> <span class="hidden sm:inline">Semana Sig.</span>
                </button>
                <button onclick="resetData()" class="text-xs bg-blue-800 p-2 rounded hover:bg-red-500 transition" title="Reset">
                    <i class="ph ph-trash"></i>
                </button>
            </div>
        </header>

        <main class="p-4 flex-1 overflow-y-auto">

            <section id="tab-empleados" class="tab-content">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-gray-800">Equipo</h2>
                    <button onclick="abrirModalEmpleado()" class="bg-blue-600 text-white px-3 py-1.5 rounded-full text-sm font-bold shadow hover:bg-blue-700 transition flex items-center gap-1">
                        <i class="ph ph-plus"></i> Nuevo
                    </button>
                </div>
                <div class="space-y-2" id="lista-empleados"></div>
            </section>

            <section id="tab-horarios" class="tab-content active">
                
                <div class="bg-gray-50 p-2 rounded-lg border mb-4 flex justify-between items-center sticky top-0 z-10 shadow-sm">
                    <button onclick="cambiarSemana(-1)" class="p-2 text-gray-600 hover:bg-gray-200 rounded-full">
                        <i class="ph ph-caret-left text-xl"></i>
                    </button>
                    <div class="text-center">
                        <span class="text-xs text-gray-500 uppercase font-bold block">Semana del</span>
                        <span id="label-semana-actual" class="font-bold text-blue-800 text-sm">Cargando...</span>
                    </div>
                    <button onclick="cambiarSemana(1)" class="p-2 text-gray-600 hover:bg-gray-200 rounded-full">
                        <i class="ph ph-caret-right text-xl"></i>
                    </button>
                </div>

                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="toggle-compacto" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 left-0 transition-all duration-300" onclick="renderTodo()"/>
                            <label for="toggle-compacto" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <label for="toggle-compacto" class="text-xs text-gray-500 font-bold cursor-pointer">Compacto</label>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="abrirVistaPrevia()" class="text-xs bg-blue-100 text-blue-700 border border-blue-200 px-3 py-1.5 rounded-full font-bold flex items-center gap-1 active:scale-95 transition">
                            <i class="ph ph-eye text-lg"></i> Ver Todo
                        </button>
                        <button onclick="compartirWhatsapp()" class="text-xs bg-green-100 text-green-700 border border-green-200 px-3 py-1.5 rounded-full font-bold flex items-center gap-1 active:scale-95 transition">
                            <i class="ph ph-whatsapp-logo text-lg"></i> Copiar
                        </button>
                    </div>
                </div>

                <div id="contenedor-dias" class="space-y-4 pb-4"></div>
            </section>

            <section id="tab-extras" class="tab-content">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-gray-800">Reporte Semanal</h2>
                    <span class="text-xs text-gray-500 text-right">Corte: <span id="rango-reporte"></span></span>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center">
                        <h4 class="text-[10px] text-blue-800 uppercase font-bold tracking-wider">Total Horas</h4>
                        <p class="text-2xl font-extrabold text-blue-600 font-mono" id="total-horas-global">0h</p>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 text-center">
                        <h4 class="text-[10px] text-orange-800 uppercase font-bold tracking-wider">Extras (>48h)</h4>
                        <p class="text-2xl font-extrabold text-orange-600 font-mono" id="total-extras-global">0h</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50 text-gray-500 uppercase text-xs font-semibold">
                            <tr>
                                <th class="p-3 text-left pl-4">Colaborador</th>
                                <th class="p-3 text-center">Total</th>
                                <th class="p-3 text-right pr-4">Extras</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="tabla-reporte"></tbody>
                    </table>
                </div>
            </section>

        </main>

        <nav class="sticky bottom-0 bg-white border-t z-30 max-w-md mx-auto shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] h-16 grid grid-cols-3 w-full">
            <button onclick="switchTab('tab-empleados', this)" class="nav-btn w-full text-gray-400 flex flex-col justify-center items-center active:bg-gray-50 border-r border-gray-100 hover:bg-gray-50 transition">
                <i class="ph ph-users text-2xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase">Equipo</span>
            </button>
            <button onclick="switchTab('tab-horarios', this)" class="nav-btn w-full text-blue-600 flex flex-col justify-center items-center active:bg-gray-50 border-r border-gray-100 hover:bg-gray-50 transition">
                <i class="ph ph-calendar-check text-2xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase">Horarios</span>
            </button>
            <button onclick="switchTab('tab-extras', this)" class="nav-btn w-full text-gray-400 flex flex-col justify-center items-center active:bg-gray-50 hover:bg-gray-50 transition">
                <i class="ph ph-chart-line-up text-2xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase">Reporte</span>
            </button>
        </nav>

        <div id="modal-turno" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
            <div class="bg-white rounded-t-2xl sm:rounded-xl shadow-xl w-full max-w-md h-[90vh] sm:h-auto flex flex-col animate-[fadeIn_0.2s]">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <div>
                        <h3 class="text-lg font-bold" id="modal-titulo-dia">Editar DÃ­a</h3>
                        <p class="text-xs text-gray-500" id="modal-subtitulo-fecha"></p>
                    </div>
                    <button onclick="closeModal('modal-turno')" class="text-gray-400 hover:text-gray-600 p-2"><i class="ph ph-x text-xl"></i></button>
                </div>

                <div class="p-4 overflow-y-auto no-scrollbar flex-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">1. Seleccionar Colaborador</label>
                    <div id="chips-empleados" class="flex flex-wrap gap-1 mb-6"></div>

                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">2. Asignar Horario</label>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="setHorario('04:00', '12:00')" class="px-2 py-2 bg-gray-100 rounded text-xs font-medium border hover:bg-blue-50 flex items-center justify-center gap-1"><i class="ph ph-sun"></i> MaÃ±ana (4-12)</button>
                        <button onclick="setHorario('05:00', '14:00')" class="px-2 py-2 bg-gray-100 rounded text-xs font-medium border hover:bg-blue-50 flex items-center justify-center gap-1"><i class="ph ph-coffee"></i> MaÃ±ana (5-2)</button>
                        <button onclick="setHorario('13:30', '21:30')" class="px-2 py-2 bg-gray-100 rounded text-xs font-medium border hover:bg-blue-50 flex items-center justify-center gap-1"><i class="ph ph-fork-knife"></i> Tarde (1:30-9:30)</button>
                        <button onclick="setHorario('17:00', '22:30')" class="px-2 py-2 bg-blue-50 text-blue-700 border-blue-200 rounded text-xs font-bold border hover:bg-blue-100 flex items-center justify-center gap-1"><i class="ph ph-moon-stars"></i> Cierre</button>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <span class="text-[10px] text-gray-400">Entrada</span>
                            <input type="time" id="hora-entrada" class="w-full border p-2 rounded font-mono bg-gray-50 text-lg">
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-400">Salida</span>
                            <input type="time" id="hora-salida" class="w-full border p-2 rounded font-mono bg-gray-50 text-lg">
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mb-6">
                        <button onclick="agregarTurno(false)" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">Asignar</button>
                        <button onclick="agregarTurno(true)" class="flex-1 bg-purple-100 text-purple-700 border border-purple-200 py-3 rounded-xl font-bold shadow-sm active:scale-95 transition text-xs flex flex-col items-center justify-center leading-tight">
                            <span>Asignar y Repetir</span>
                            <span class="text-[9px] font-normal opacity-75">Resto de semana</span>
                        </button>
                    </div>

                    <div class="border-t pt-4">
                        <h4 class="text-sm font-bold mb-3 text-gray-700">Turnos Hoy</h4>
                        <div id="lista-turnos-modal" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="modal-empleado" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 animate-[fadeIn_0.2s]">
                <h3 class="text-lg font-bold mb-4 flex justify-between items-center">
                    <span id="titulo-modal-empleado">Nuevo Colaborador</span>
                    <i class="ph ph-user-circle text-2xl text-blue-600"></i>
                </h3>
                <input type="hidden" id="input-id-empleado">
                <div class="space-y-3 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label>
                        <input type="text" id="input-nombre-empleado" class="w-full border p-2 rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Apellidos</label>
                        <input type="text" id="input-apellido-empleado" class="w-full border p-2 rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">TelÃ©fono</label>
                        <input type="tel" id="input-telefono-empleado" class="w-full border p-2 rounded-lg bg-gray-50 font-mono">
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-2 border-t">
                    <button onclick="closeModal('modal-empleado')" class="px-4 py-2 text-gray-500 font-bold rounded-lg hover:bg-gray-100">Cancelar</button>
                    <button onclick="guardarEmpleado()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold shadow">Guardar</button>
                </div>
            </div>
        </div>

        <div id="modal-export" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-2 backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col max-h-[95vh] animate-[fadeIn_0.2s]">
                <div class="p-3 border-b flex items-center justify-between bg-gray-50 rounded-t-xl">
                    <button onclick="exportarImagen()" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded-full font-bold shadow hover:bg-indigo-700 transition flex items-center gap-1">
                        <i class="ph ph-download-simple"></i> Guardar Imagen
                    </button>
                    <h3 class="text-md font-bold text-gray-800">Vista Completa</h3>
                    <button onclick="closeModal('modal-export')" class="text-gray-400 hover:text-gray-600"><i class="ph ph-x text-xl"></i></button>
                </div>
                
                <div class="overflow-y-auto p-4 bg-gray-100" id="contenido-vista-previa"></div>
                
                <div class="p-4 border-t bg-white rounded-b-xl">
                    <button onclick="closeModal('modal-export')" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">Cerrar</button>
                </div>
            </div>
        </div>

        <div id="capture-container" class="fixed top-0 left-0 -z-50 bg-white" style="visibility: hidden;"></div>

    </div>

    <script>
        // --- CONFIG Y DATOS ---
        const JORNADA_SEMANAL_LEGAL = 48;
        let currentMonday = getStartOfWeek(new Date());
        let selectedEmployee = null;
        let editingDateKey = null; 
        let editEmployeeIndex = null;
        let isCompactMode = false;

        let rawEmpleados = JSON.parse(localStorage.getItem('soda_empleados'));
        let empleados = [];
        if (!rawEmpleados) {
            empleados = [{nombre: "Fran", apellido:"", telefono:""}, {nombre: "Carolina", apellido:"", telefono:""}, {nombre: "Sasha", apellido:"", telefono:""}, {nombre: "Noilyn", apellido:"", telefono:""}];
        } else if (rawEmpleados.length > 0 && typeof rawEmpleados[0] === 'string') {
            empleados = rawEmpleados.map(nombre => ({ nombre: nombre, apellido: "", telefono: "" }));
            localStorage.setItem('soda_empleados', JSON.stringify(empleados));
        } else {
            empleados = rawEmpleados;
        }

        let dbTurnos = JSON.parse(localStorage.getItem('soda_db_turnos')) || {};
        const weekColors = [
            "bg-yellow-50 border-l-4 border-yellow-400 text-yellow-900",
            "bg-orange-50 border-l-4 border-orange-400 text-orange-900",
            "bg-blue-50 border-l-4 border-blue-400 text-blue-900",
            "bg-purple-50 border-l-4 border-purple-400 text-purple-900",
            "bg-pink-50 border-l-4 border-pink-400 text-pink-900",
            "bg-green-50 border-l-4 border-green-400 text-green-900",
            "bg-rose-50 border-l-4 border-rose-400 text-rose-900"
        ];

        // --- CORE FUNCTIONS ---
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function cambiarSemana(direccion) {
            currentMonday.setDate(currentMonday.getDate() + (direccion * 7));
            renderTodo();
        }

        function getFechaKey(date) {
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset*60*1000));
            return localDate.toISOString().split('T')[0];
        }

        function formatFechaLegible(date) {
            const diaNombre = date.toLocaleDateString('es-CR', { weekday: 'long' });
            const diaNum = date.getDate();
            return `${diaNombre.charAt(0).toUpperCase() + diaNombre.slice(1)} ${diaNum}`;
        }

        function saveData() {
            localStorage.setItem('soda_empleados', JSON.stringify(empleados));
            localStorage.setItem('soda_db_turnos', JSON.stringify(dbTurnos));
            renderTodo();
        }

        function resetData() {
            if(confirm("Â¿Restaurar datos de fÃ¡brica?")) {
                localStorage.removeItem('soda_empleados');
                localStorage.removeItem('soda_db_turnos');
                location.reload();
            }
        }

        // --- RENDERIZADO ---
        function renderTodo() {
            isCompactMode = document.getElementById('toggle-compacto')?.checked || false;
            renderEmpleados();
            renderSemanaView();
            calcularTotalesReporte();
        }

        function renderEmpleados() {
            const lista = document.getElementById('lista-empleados');
            const chips = document.getElementById('chips-empleados');
            lista.innerHTML = '';
            chips.innerHTML = '';

            empleados.forEach((emp, index) => {
                lista.innerHTML += `
                    <div class="flex items-center justify-between bg-white shadow-sm rounded-lg border-l-4 border-blue-500 overflow-hidden hover:bg-gray-50 transition">
                        <div class="flex-1 p-3 cursor-pointer" onclick="abrirModalEmpleado(${index})">
                            <span class="font-bold text-gray-700 block">${emp.nombre} ${emp.apellido}</span>
                            ${emp.telefono ? `<span class="text-xs text-gray-400 flex items-center gap-1"><i class="ph ph-phone"></i> ${emp.telefono}</span>` : ''}
                        </div>
                        <button onclick="borrarEmpleado(${index})" class="text-red-400 hover:text-white hover:bg-red-500 h-full px-4 transition border-l border-gray-100">
                            <i class="ph ph-trash text-lg"></i>
                        </button>
                    </div>`;
                chips.innerHTML += `
                    <button onclick="selectChip(this, '${emp.nombre}')" class="chip-emp px-3 py-2 rounded-lg border border-gray-200 text-xs font-bold bg-white text-gray-600 hover:border-blue-500 transition flex-grow text-center min-w-[60px]">
                        ${emp.nombre}
                    </button>`;
            });
        }

        function renderSemanaView() {
            const container = document.getElementById('contenedor-dias');
            container.innerHTML = '';
            const finSemana = new Date(currentMonday);
            finSemana.setDate(finSemana.getDate() + 6);
            document.getElementById('label-semana-actual').innerText = 
                `${currentMonday.getDate()}/${currentMonday.getMonth()+1} - ${finSemana.getDate()}/${finSemana.getMonth()+1}`;
            document.getElementById('rango-reporte').innerText = document.getElementById('label-semana-actual').innerText;

            for (let i = 0; i < 7; i++) {
                let fechaDia = new Date(currentMonday);
                fechaDia.setDate(currentMonday.getDate() + i);
                const fechaKey = getFechaKey(fechaDia);
                const turnosDelDia = dbTurnos[fechaKey] || [];
                const nombreDia = formatFechaLegible(fechaDia);
                const colorClase = weekColors[i];

                let totalHorasDia = 0;
                turnosDelDia.forEach(t => totalHorasDia += calcularDuracion(t.entrada, t.salida));
                turnosDelDia.sort((a,b) => a.entrada.localeCompare(b.entrada));

                let turnosHTML = '';
                turnosDelDia.forEach((t, idx) => {
                    const padding = isCompactMode ? 'py-1' : 'py-2';
                    const fontSize = isCompactMode ? 'text-xs' : 'text-sm';
                    turnosHTML += `
                        <div class="turno-item flex justify-between items-center border-b last:border-0 ${padding} border-gray-200/50" 
                             onmousedown="startLongPress(this, '${fechaKey}', ${idx})" 
                             ontouchstart="startLongPress(this, '${fechaKey}', ${idx})" 
                             onmouseup="cancelLongPress()" 
                             ontouchend="cancelLongPress()"
                             onmouseleave="cancelLongPress()">
                            <span class="font-bold text-gray-700 ${fontSize} flex items-center gap-2">
                                <i class="ph ph-user text-gray-400 text-xs"></i> ${t.nombre}
                            </span>
                            <span class="text-xs bg-white/80 px-2 py-0.5 rounded border border-gray-200 font-mono text-gray-600">${t.formato}</span>
                        </div>`;
                });

                const trabajando = turnosDelDia.map(t => t.nombre);
                const libres = empleados.filter(e => !trabajando.includes(e.nombre)).map(e => e.nombre);
                let libresHTML = (libres.length > 0 && turnosDelDia.length > 0 && !isCompactMode)
                    ? `<div class="mt-2 pt-2 border-t border-dashed border-gray-300 text-[10px] text-gray-500 flex flex-wrap gap-1 items-center">
                        <span class="font-bold text-green-700 bg-green-100 px-1 rounded uppercase">Libres:</span> ${libres.join(', ')}
                       </div>` : '';

                const headerPad = isCompactMode ? 'py-1 px-3' : 'py-2 px-4';
                container.innerHTML += `
                    <article class="shadow-sm rounded-lg overflow-hidden border border-gray-200 bg-white">
                        <div class="${colorClase} ${headerPad} flex justify-between items-center cursor-pointer select-none" onclick="abrirEditorDia('${fechaKey}', '${nombreDia}')">
                            <div class="flex items-baseline gap-2">
                                <span class="font-bold ${isCompactMode ? 'text-xs' : 'text-sm'}">${nombreDia}</span>
                                <span class="text-[10px] bg-white/40 px-1 rounded font-mono font-bold opacity-70">${totalHorasDia}h</span>
                            </div>
                            <div class="bg-white/50 px-2 py-1 rounded text-[10px] font-bold flex items-center gap-1 hover:bg-white transition text-gray-700">
                                <i class="ph ph-pencil-simple"></i>
                            </div>
                        </div>
                        <div class="p-3 relative ${isCompactMode ? 'pt-1 pb-1' : ''}">
                            ${turnosHTML || '<p class="text-gray-400 text-xs italic text-center py-1">Sin turnos</p>'}
                            ${libresHTML}
                        </div>
                    </article>`;
            }
        }

        // --- FUNCIONES EXTRA ---
        function duplicarSemanaSiguiente() {
            if(!confirm("Â¿Copiar toda la semana actual a la siguiente? (SobrescribirÃ¡ si ya existen datos)")) return;
            for(let i=0; i<7; i++) {
                let fechaOrigen = new Date(currentMonday);
                fechaOrigen.setDate(currentMonday.getDate() + i);
                let keyOrigen = getFechaKey(fechaOrigen);
                let fechaDestino = new Date(fechaOrigen);
                fechaDestino.setDate(fechaOrigen.getDate() + 7);
                let keyDestino = getFechaKey(fechaDestino);
                if(dbTurnos[keyOrigen]) dbTurnos[keyDestino] = JSON.parse(JSON.stringify(dbTurnos[keyOrigen]));
            }
            saveData();
            cambiarSemana(1);
            alert("Â¡Semana duplicada con Ã©xito!");
        }

        function abrirModalEmpleado(index = null) {
            editEmployeeIndex = index;
            const titulo = document.getElementById('titulo-modal-empleado');
            const inNombre = document.getElementById('input-nombre-empleado');
            const inApellido = document.getElementById('input-apellido-empleado');
            const inTel = document.getElementById('input-telefono-empleado');

            if (index !== null) {
                const emp = empleados[index];
                titulo.innerText = "Editar Colaborador";
                inNombre.value = emp.nombre;
                inApellido.value = emp.apellido || "";
                inTel.value = emp.telefono || "";
            } else {
                titulo.innerText = "Nuevo Colaborador";
                inNombre.value = "";
                inApellido.value = "";
                inTel.value = "";
            }
            openModal('modal-empleado');
        }

        function guardarEmpleado() {
            const nombre = document.getElementById('input-nombre-empleado').value.trim();
            const apellido = document.getElementById('input-apellido-empleado').value.trim();
            const telefono = document.getElementById('input-telefono-empleado').value.trim();
            if (!nombre) return alert("El nombre es obligatorio");

            if (editEmployeeIndex !== null) {
                const empAntiguo = empleados[editEmployeeIndex];
                if (empAntiguo.nombre !== nombre) {
                    if(confirm(`Â¿Actualizar turnos de "${empAntiguo.nombre}" a "${nombre}"?`)) {
                        Object.keys(dbTurnos).forEach(key => {
                            dbTurnos[key].forEach(turno => { if (turno.nombre === empAntiguo.nombre) turno.nombre = nombre; });
                        });
                    }
                }
                empleados[editEmployeeIndex] = { nombre, apellido, telefono };
            } else {
                empleados.push({ nombre, apellido, telefono });
            }
            saveData();
            closeModal('modal-empleado');
        }

        function borrarEmpleado(index) {
            if(confirm("Â¿Eliminar empleado?")) {
                empleados.splice(index, 1);
                saveData();
            }
            event.stopPropagation();
        }

        function abrirEditorDia(fechaKey, nombreDia) {
            editingDateKey = fechaKey;
            document.getElementById('modal-titulo-dia').innerText = `Editar: ${nombreDia}`;
            document.getElementById('modal-subtitulo-fecha').innerText = fechaKey;
            renderListaTurnosModal();
            openModal('modal-turno');
        }

        function renderListaTurnosModal() {
            const container = document.getElementById('lista-turnos-modal');
            container.innerHTML = '';
            const turnos = dbTurnos[editingDateKey] || [];
            if(turnos.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">No hay turnos asignados hoy.</p>';
                return;
            }
            const turnosOrdenados = [...turnos].sort((a, b) => a.entrada.localeCompare(b.entrada) || a.salida.localeCompare(b.salida));
            turnosOrdenados.forEach((t, idx) => {
                let alerta = '';
                const conflicto = detectarConflictoTurno(t, turnosOrdenados, idx);
                if(conflicto) alerta = `<span class="text-[10px] text-red-500 font-bold ml-2"><i class="ph ph-warning"></i> Solape</span>`;
                container.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100 mb-2 select-none">
                        <div>
                            <span class="font-bold text-gray-700 block text-sm">${t.nombre} ${alerta}</span>
                            <span class="text-xs text-gray-500 font-mono bg-white px-1 border rounded">${t.formato}</span>
                        </div>
                        <button onclick="eliminarTurno('${editingDateKey}', ${idx})" class="text-gray-400 hover:text-red-500 p-2">
                            <i class="ph ph-trash text-lg"></i>
                        </button>
                    </div>`;
            });
        }

        function detectarConflictoTurno(turnoActual, todosTurnos, idxActual) {
            const startA = parseFloat(turnoActual.entrada.replace(':','.')); 
            const endA = parseFloat(turnoActual.salida.replace(':','.')); 
            return todosTurnos.some((t, i) => {
                if(i === idxActual || t.nombre !== turnoActual.nombre) return false;
                const startB = parseFloat(t.entrada.replace(':','.'));
                const endB = parseFloat(t.salida.replace(':','.'));
                return (startA < endB && endA > startB);
            });
        }

        function agregarTurno(repetir = false) {
            const entrada = document.getElementById('hora-entrada').value;
            const salida = document.getElementById('hora-salida').value;
            if (!selectedEmployee || !entrada || !salida) { alert("Faltan datos"); return; }
            if(entrada > salida && salida > "06:00") {
               if(!confirm("La hora de salida es antes que la entrada. Â¿Es turno nocturno cruzando medianoche?")) return;
            }
            const formatoReadable = `${formatTime(entrada)} - ${formatTime(salida)}`;
            const pushTurno = (key) => {
                if (!dbTurnos[key]) dbTurnos[key] = [];
                const existe = dbTurnos[key].some(t => t.nombre === selectedEmployee && t.entrada === entrada && t.salida === salida);
                if(!existe) dbTurnos[key].push({ nombre: selectedEmployee, entrada, salida, formato: formatoReadable });
            };
            pushTurno(editingDateKey);
            if (repetir) {
                const fechaBase = new Date(editingDateKey + "T00:00:00");
                const diffTime = Math.abs(fechaBase - currentMonday);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                for (let i = diffDays + 1; i < 7; i++) {
                    let nextDate = new Date(currentMonday);
                    nextDate.setDate(currentMonday.getDate() + i);
                    pushTurno(getFechaKey(nextDate));
                }
                alert("Turno repetido hasta el domingo.");
            }
            saveData();
            renderListaTurnosModal();
            if(!repetir) {
                document.querySelectorAll('.chip-emp').forEach(c => c.classList.remove('bg-blue-600', 'text-white', 'border-blue-600'));
                selectedEmployee = null;
            } else { closeModal('modal-turno'); }
        }

        function eliminarTurno(fechaKey, idx) {
            if (dbTurnos[fechaKey]) {
                dbTurnos[fechaKey].splice(idx, 1);
                if (dbTurnos[fechaKey].length === 0) delete dbTurnos[fechaKey];
                saveData();
                if(!document.getElementById('modal-turno').classList.contains('hidden')) renderListaTurnosModal();
            }
        }

        // --- EXPORTACIÃ“N HORIZONTAL (LANDSCAPE) ---
        function exportarImagen() {
            const captureDiv = document.getElementById('capture-container');
            captureDiv.style.visibility = 'visible';
            captureDiv.innerHTML = '';

            const tituloSemana = document.getElementById('label-semana-actual').innerText;
            
            // Layout: Horizontal (7 cols)
            // Width: 1800px para buena resoluciÃ³n
            let html = `
                <div class="bg-white p-8 font-sans" style="width: 1800px;">
                    <div class="text-center mb-6">
                        <h1 class="text-4xl font-bold text-gray-800 uppercase tracking-wide">Horario Semanal</h1>
                        <h2 class="text-xl text-blue-600 font-bold mt-2">${tituloSemana}</h2>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-4 border-t border-gray-200 pt-6">
            `;

            for (let i = 0; i < 7; i++) {
                let fechaDia = new Date(currentMonday);
                fechaDia.setDate(currentMonday.getDate() + i);
                const diaNombre = fechaDia.toLocaleDateString('es-CR', { weekday: 'long' }).toUpperCase();
                const dia = fechaDia.getDate().toString().padStart(2, '0');
                const key = getFechaKey(fechaDia);
                let turnos = dbTurnos[key] || [];
                turnos.sort((a,b) => a.entrada.localeCompare(b.entrada));

                // Columna por dÃ­a
                html += `
                    <div class="flex flex-col bg-gray-50 rounded-xl overflow-hidden border border-gray-100">
                        <div class="bg-blue-600 text-white p-3 text-center">
                            <div class="text-xs font-bold opacity-75">${diaNombre}</div>
                            <div class="text-2xl font-bold">${dia}</div>
                        </div>
                        
                        <div class="p-2 space-y-2 flex-1 min-h-[200px]">
                `;
                
                if(turnos.length === 0) {
                     html += `<div class="text-center text-gray-400 italic text-sm mt-10">Libre</div>`;
                }

                turnos.forEach(t => {
                    html += `
                        <div class="bg-white p-2 rounded shadow-sm border-l-4 border-blue-400">
                            <div class="font-bold text-gray-800 text-sm truncate">${t.nombre}</div>
                            <div class="text-xs text-gray-500 font-mono mt-1">${t.formato}</div>
                        </div>`;
                });

                html += `</div></div>`;
            }
            
            html += `
                    </div>
                    <div class="mt-8 text-center text-gray-300 text-sm">Generado con Soda Planner Pro â˜•</div>
                </div>`;

            captureDiv.innerHTML = html;

            setTimeout(() => {
                html2canvas(captureDiv, {
                    scale: 1, // 1800px width base
                    windowWidth: 1800,
                    useCORS: true
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Horario_${tituloSemana.replace('/','-')}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    captureDiv.style.visibility = 'hidden';
                    captureDiv.innerHTML = '';
                });
            }, 100);
        }

        function abrirVistaPrevia() {
            const container = document.getElementById('contenido-vista-previa');
            container.innerHTML = '';
            let html = `<div class="space-y-4 font-mono text-sm">`;
            for (let i = 0; i < 7; i++) {
                let fechaDia = new Date(currentMonday);
                fechaDia.setDate(currentMonday.getDate() + i);
                const diaNombre = fechaDia.toLocaleDateString('es-CR', { weekday: 'long' }).toUpperCase();
                const dia = fechaDia.getDate().toString().padStart(2, '0');
                const fechaTitulo = `${diaNombre} ${dia}`;
                const key = getFechaKey(fechaDia);
                let turnos = dbTurnos[key] || [];
                turnos.sort((a,b) => a.entrada.localeCompare(b.entrada));

                html += `<div class="bg-white p-3 rounded border border-gray-200 shadow-sm">
                        <div class="font-bold border-b pb-1 mb-2 text-blue-800 text-xs tracking-wider">${fechaTitulo}</div>
                        ${turnos.length === 0 ? '<span class="text-gray-400 italic text-xs">Cerrado / Libre</span>' : ''}
                        <ul class="space-y-1">`;
                turnos.forEach(t => {
                    html += `<li class="flex justify-between"><span class="font-bold text-gray-700">${t.nombre}</span><span>${t.formato}</span></li>`;
                });
                html += `</ul></div>`;
            }
            html += `</div>`;
            container.innerHTML = html;
            openModal('modal-export');
        }

        function calcularTotalesReporte() {
            const reporte = {};
            let totalHoras = 0;
            let totalExtras = 0;
            empleados.forEach(e => reporte[e.nombre] = { total: 0 });

            for (let i = 0; i < 7; i++) {
                let fechaDia = new Date(currentMonday);
                fechaDia.setDate(currentMonday.getDate() + i);
                const key = getFechaKey(fechaDia);
                const turnos = dbTurnos[key] || [];
                turnos.forEach(t => {
                    if (reporte[t.nombre]) {
                        reporte[t.nombre].total += calcularDuracion(t.entrada, t.salida);
                    }
                });
            }

            const tbody = document.getElementById('tabla-reporte');
            tbody.innerHTML = '';
            Object.entries(reporte).forEach(([nombre, data]) => {
                if (data.total > 0) {
                    const extras = Math.max(0, data.total - JORNADA_SEMANAL_LEGAL);
                    totalHoras += data.total;
                    totalExtras += extras;
                    const alertaClase = extras > 0 ? 'text-red-600 font-extrabold bg-red-50' : 'text-gray-700';
                    const iconAlerta = extras > 0 ? '<i class="ph ph-warning"></i> ' : '';

                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 ${alertaClase}">
                            <td class="p-3 pl-4 font-medium flex items-center gap-1">${iconAlerta}${nombre}</td>
                            <td class="p-3 text-center font-mono font-bold">${data.total.toFixed(1)}h</td>
                            <td class="p-3 pr-4 text-right font-bold ${extras > 0 ? 'text-red-600' : 'text-gray-300'}">${extras > 0 ? '+' + extras.toFixed(1) : '-'}</td>
                        </tr>`;
                }
            });
            document.getElementById('total-horas-global').innerText = totalHoras.toFixed(1) + "h";
            document.getElementById('total-extras-global').innerText = totalExtras.toFixed(1) + "h";
        }

        // --- HELPERS ---
        let pressTimer;
        let pressTarget = null;
        function startLongPress(element, dateKey, idx) {
            if(event.target.closest('button')) return;
            element.classList.add('active:bg-red-50');
            pressTarget = element;
            pressTimer = setTimeout(() => {
                if (confirm("Â¿Borrar turno?")) eliminarTurno(dateKey, idx);
                element.classList.remove('deleting');
            }, 800);
        }
        function cancelLongPress() {
            if(pressTarget) pressTarget.classList.remove('deleting');
            clearTimeout(pressTimer);
            pressTarget = null;
        }
        function selectChip(btn, nombre) {
            document.querySelectorAll('.chip-emp').forEach(c => { c.classList.remove('bg-blue-600', 'text-white', 'border-blue-600'); c.classList.add('bg-white', 'text-gray-600'); });
            btn.classList.remove('bg-white', 'text-gray-600');
            btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            selectedEmployee = nombre;
        }
        function setHorario(inTime, outTime) {
            document.getElementById('hora-entrada').value = inTime;
            document.getElementById('hora-salida').value = outTime;
        }
        function calcularDuracion(entrada, salida) {
            const start = new Date("2000-01-01T" + entrada);
            let end = new Date("2000-01-01T" + salida);
            if (end < start) end.setDate(end.getDate() + 1); 
            return (end - start) / (1000 * 60 * 60);
        }
        function formatTime(timeStr) {
            const [h, m] = timeStr.split(':');
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'pm' : 'am';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${m}${ampm}`;
        }
        function compartirWhatsapp() {
            let texto = `*HORARIO SODA* ðŸ“…\nSemana: ${document.getElementById('label-semana-actual').innerText}\n\n`;
            for (let i = 0; i < 7; i++) {
                let fechaDia = new Date(currentMonday);
                fechaDia.setDate(currentMonday.getDate() + i);
                const key = getFechaKey(fechaDia);
                let turnos = dbTurnos[key] || [];
                turnos.sort((a,b) => a.entrada.localeCompare(b.entrada));
                texto += `*${formatFechaLegible(fechaDia)}*:\n`;
                if(turnos.length === 0) texto += "ðŸš« Cerrado\n";
                turnos.forEach(t => texto += `ðŸ‘¤ ${t.nombre}: ${t.formato}\n`);
                texto += "\n";
            }
            navigator.clipboard.writeText(texto).then(() => alert("Copiado al portapapeles"));
        }
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('text-blue-600'); b.classList.add('text-gray-400'); });
            btn.classList.remove('text-gray-400');
            btn.classList.add('text-blue-600');
            if(tabId === 'tab-horarios') renderTodo();
        }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); renderTodo(); }

        document.addEventListener('DOMContentLoaded', () => { renderTodo(); });

    </script>
</body>
</html>